<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin=""></script>
    <style>
        #map {
            height: 100vh;
            width: 100vw;
            background: black;
        }
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
  // screenshots taken at 0.25, 8 pixels per game unit
  // we took 9x9 screenshots
  // 9 screenshots * 4096px = 36,864px
  // 36,864px / 8px = 4608 game units

  // 4096px screenshot / 8px = 512 game units

  // there's no bloody 12s anywhere, 144 is just (4608/2)/16
  // 4608 is the width of the world in game units
  // 16 is the scale factor (from the 0.25 screenshot zoom factor)
  // (4608/2) is the offset for us to have 0,0 as the center of the world
  // ((4608/2)/16) is 144

  // not entirely sure where the 16 comes from, 0.25 screenshot factor is supposed to be
  // 8 pixels per game unit; 256 (tile in px)/8 would be 32.

  // a zoom level of 7 means 2^7 tiles (128). 128 * 256px tiles = 32,768px. 32,768px / 4096px = 8 screenshots?
  // obviously we've off-by-one'd somewhere; must be ignoring the last set of screenshots.

  // more realistically; we're talking about the -4 of the first screenshot; 144 is just
  // (144 * 16 (scale factor)) / 512 (game tile width of a screenshot) = (-)4.5?
  // 4.5 * (512/16) = 144
  // .5 comes from the screenshots being based on the centre, not the top-left corner.

  // > Represents an affine transformation: a set of coefficients a, b, c, d for transforming
  // > a point of a form (x, y) into (a*x + b, c*y + d) and doing the reverse.
  let trans = new L.Transformation(1/16, 144, 1/16, 144);
  L.CRS.MySimple = L.extend({}, L.CRS.Simple, {
    transformation: trans,
  });
  const map = L.map('map', {
    crs: L.CRS.MySimple,
  }).setView([0, 0], 7);
  L.tileLayer('out/{z}/{x}/{y}.avif', {
    minZoom: 3,
    maxNativeZoom: 7,
    maxZoom: 10,
  }).addTo(map);

  var popup = L.popup();

  function onMapClick(e) {
    let back = trans.transform(e.latlng);
    popup
      .setLatLng(e.latlng)
      .setContent(`[gps=${back.lng.toFixed()}, ${back.lat.toFixed()}]`)
      .openOn(map);
  }

  map.on('click', onMapClick);
</script>
</body>
</html>
